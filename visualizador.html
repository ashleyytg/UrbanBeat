<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UrbanBeat - Ve al ritmo de la ciudad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: #f4f4f5; display: flex; flex-direction: column; }
    #map { height: 500px; width: 100%; border-radius: 0.5rem; }
    @media (max-width: 768px) { #map { height: 300px; } }
    #info { position: absolute; bottom: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; z-index: 1000; display: none; font-size: 0.9em; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #error-message { color: #ef4444; margin-top: 15px; font-weight: 500; display: none; text-align: center; padding: 10px; background-color: #fee2e2; border-radius: 8px; border: 1px solid #fca5a5; }
    .header-bg-image { background-image: url('https://www.peru.travel/Contenido/Atractivo/Imagen/es/14/1.1/Principal/centro-historico-de-lima.jpg'); background-size: cover; background-position: center; position: relative; overflow: hidden; }
    .header-bg-image::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 1; }
    .header-content { position: relative; z-index: 2; }
  </style>
</head>
<body class="font-sans text-gray-800">

  <header class="bg-emerald-700 text-white p-4 shadow-md">
    <nav class="container mx-auto flex justify-between items-center">
      <a href="#" class="text-3xl font-bold tracking-tight text-emerald-50 hover:text-emerald-200">UrbanBeat</a>
      <ul class="flex space-x-6">
        <li><a href="#" class="hover:text-emerald-200">Inicio</a></li>
        <li><a href="#" class="hover:text-emerald-200">Explorar</a></li>
        <li><a href="#" class="hover:text-emerald-200">Acerca de</a></li>
        <li><a href="#" class="hover:text-emerald-200">Contacto</a></li>
      </ul>
    </nav>
  </header>

  <section class="header-bg-image py-20 px-4 text-center text-white">
    <div class="header-content container mx-auto">
      <h1 class="text-5xl font-extrabold mb-4 leading-tight">UrbanBeat</h1>
      <p class="text-xl opacity-90">Tu pulso urbano en Lima</p>
    </div>
  </section>

  <!-- Formulario de b√∫squeda -->
  <main class="container mx-auto py-12 px-4 flex-grow">
    <h2 class="text-4xl font-bold text-center mb-6 text-emerald-800">Visor Autom√°tico de Rutas</h2>
    <p class="text-center text-gray-600 mb-8">Busca un lugar y visualiza la ruta generada autom√°ticamente.</p>

    <div class="flex flex-col md:flex-row gap-4 justify-center mb-8">
      <input id="query" type="text" placeholder="¬øQu√© buscas? (ej. restaurante)" class="px-4 py-2 border border-gray-300 rounded-md w-full md:w-1/3">
      <input id="location" type="text" placeholder="¬øD√≥nde? (ej. Cieneguilla, Lima, Per√∫)" class="px-4 py-2 border border-gray-300 rounded-md w-full md:w-1/3">
      <button onclick="realizarBusqueda()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 hover:scale-105">
        Realizar B√∫squeda üîç
      </button>
    </div>

    <div id="error-message" class="max-w-md mx-auto"></div>

    <!-- Mapa -->
    <div id="map-container" class="relative bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden mt-8">
      <div id="map" class="min-h-[300px] md:min-h-[500px]"></div>
      <div id="info"></div>
    </div>
  </main>

  <!-- TripAdvisor iframe -->
  <div id="tripadvisor-container" class="container mx-auto my-12 px-4 hidden">
    <h3 class="text-2xl font-semibold text-center text-emerald-800 mb-4">Explora en TripAdvisor</h3>
    <iframe id="tripadvisor-frame"
            class="w-full h-[500px] rounded-lg border-2 border-emerald-400 shadow-md"
            loading="lazy"
            referrerpolicy="no-referrer"
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms">
    </iframe>
  </div>

  <footer class="bg-gray-800 text-white py-6 px-4 text-center mt-auto">
    <div class="container mx-auto">
      <p>&copy; 2025 UrbanBeat. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    let map;
    let lastQuery = '';
    let lastLocation = '';

    function initializeMap() {
      if (map) map.remove();
      map = L.map('map').setView([-12.0464, -77.0428], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
    }

    async function realizarBusqueda() {
      const query = document.getElementById('query').value.trim();
      const location = document.getElementById('location').value.trim();
      const errorDiv = document.getElementById('error-message');
      errorDiv.style.display = 'none';

      lastQuery = query;
      lastLocation = location;

      try {
        const res = await fetch('http://localhost:5000/api/ejecutar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, location })
        });
        const data = await res.json();

        if (data.success) {
          await loadAndVisualizeRoute();

          document.getElementById('query').value = "";
          document.getElementById('location').value = "";
        } else {
          throw new Error(data.message || 'Error desconocido');
        }
      } catch (e) {
        errorDiv.textContent = `‚ùå ${e.message}`;
        errorDiv.style.display = 'block';
      }
    }

    async function loadAndVisualizeRoute() {
      const errorDiv = document.getElementById('error-message');
      errorDiv.style.display = 'none';
      if (window.routeLayer) map.removeLayer(window.routeLayer);
      if (window.startMarker) map.removeLayer(window.startMarker);
      if (window.endMarker) map.removeLayer(window.endMarker);
      const infoDiv = document.getElementById('info');
      infoDiv.style.display = 'none';

      try {
        const response = await fetch('ruta.json');
        if (!response.ok) throw new Error('No se pudo cargar el archivo ruta.json');
        const routeData = await response.json();

        const route = routeData.features[0];
        const coords = route.geometry.coordinates[0].map(c => [c[1], c[0]]);
        const routeLine = L.polyline(coords, { color: '#3b82f6', weight: 5, opacity: 0.7 });

        const startMarker = L.marker(coords[0]).bindPopup("üìç Inicio");
        const endMarker = L.marker(coords[coords.length - 1]).bindPopup("üèÅ Fin");

        window.startMarker = startMarker;
        window.endMarker = endMarker;

        window.routeLayer = L.layerGroup([routeLine, startMarker, endMarker]).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

        const distancia = (route.properties.distance / 1000).toFixed(2);
        const tiempo = (route.properties.time / 60).toFixed(1);

        infoDiv.innerHTML = `<b>Buscaste:</b> ${document.getElementById('query').value || lastQuery}<br><b>En:</b> ${document.getElementById('location').value || lastLocation}<br><b>Distancia:</b> ${distancia} km<br><b>Tiempo:</b> ${tiempo} min`;
        infoDiv.style.display = 'block';

        // Mostrar TripAdvisor
        const tripFrameDiv = document.getElementById('tripadvisor-container');
        const tripFrame = document.getElementById('tripadvisor-frame');
        const encodedQuery = encodeURIComponent(lastQuery);
        tripFrame.src = `https://www.tripadvisor.com.pe/Search?q=${encodeURIComponent(lastLocation)}`;
        tripFrameDiv.style.display = 'block';

      } catch (e) {
        errorDiv.textContent = `Error al mostrar la ruta: ${e.message}`;
        errorDiv.style.display = 'block';
      }
    }

    document.addEventListener('DOMContentLoaded', initializeMap);
  </script>
</body>
</html>
