<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Configuraci√≥n b√°sica del documento HTML -->
    <meta charset="UTF-8"> <!-- Define la codificaci√≥n de caracteres a UTF-8, crucial para mostrar correctamente caracteres especiales y acentos en espa√±ol. Es como decirle al navegador qu√© "idioma de caracteres" usar. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Esencial para la responsividad. Asegura que la p√°gina se adapte y se vea bien en diferentes dispositivos (m√≥viles, tablets, computadoras), ajustando el ancho a la pantalla del dispositivo. -->
    <title>UrbanBeat - Ve al ritmo de la ciudad</title> <!-- El t√≠tulo que aparece en la pesta√±a o ventana del navegador. Es el nombre de nuestra aplicaci√≥n. -->

    <!-- Inclusi√≥n de librer√≠as y frameworks externos -->
    <script src="https://cdn.tailwindcss.com"></script> <!-- Incluye Tailwind CSS. Es un framework que nos permite estilizar la p√°gina de forma r√°pida y moderna directamente en el HTML, sin escribir mucho CSS personalizado. Nos ayuda a que la p√°gina se vea bien sin esfuerzo. -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /> <!-- Enlaza la hoja de estilos de Leaflet. Leaflet es una librer√≠a JavaScript para crear mapas interactivos, y este CSS le da la apariencia b√°sica al mapa. -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> <!-- Incluye el c√≥digo JavaScript de Leaflet. Este script es el "cerebro" que permite que el mapa funcione, se mueva, muestre marcadores, etc. -->

    <!-- Estilos CSS personalizados para la aplicaci√≥n -->
    <style>
        /* Estilos generales para todo el documento HTML y el cuerpo de la p√°gina */
        html, body {
            height: 100%; /* Asegura que la p√°gina ocupe toda la altura disponible en la ventana del navegador, lo que es clave para un dise√±o responsivo. */
            margin: 0; /* Elimina los m√°rgenes predeterminados del navegador, d√°ndonos control total sobre el espaciado. */
            padding: 0; /* Elimina el relleno predeterminado del navegador. */
            font-family: 'Inter', sans-serif; /* Define la tipograf√≠a principal de la aplicaci√≥n. 'Inter' es una fuente moderna y legible. */
            background-color: #f4f4f5; /* Establece un color de fondo suave para toda la p√°gina, creando una est√©tica limpia. */
            display: flex; /* Habilita Flexbox. Esto es fundamental para organizar los elementos de la p√°gina de manera flexible, en este caso, en una columna. */
            flex-direction: column; /* Organiza los elementos hijos del <body> (encabezado, contenido principal, pie de p√°gina) en una pila vertical. */
        }
        /* Estilos espec√≠ficos para el contenedor del mapa Leaflet */
        #map {
            height: 500px; /* Define la altura inicial del mapa en pantallas grandes. */
            width: 100%; /* Asegura que el mapa ocupe todo el ancho disponible de su contenedor, adapt√°ndose al espacio. */
            border-radius: 0.5rem; /* Aplica bordes redondeados al mapa, d√°ndole un aspecto m√°s moderno y suave. */
        }
        /* Media query para hacer el mapa responsivo en pantallas m√°s peque√±as (ej. m√≥viles) */
        @media (max-width: 768px) {
            #map { height: 300px; } /* Cuando la pantalla es peque√±a (menos de 768px de ancho), la altura del mapa se reduce para adaptarse mejor a la visualizaci√≥n m√≥vil. */
        }
        /* Estilos para el cuadro de informaci√≥n que se superpone al mapa */
        #info {
            position: absolute; /* Permite posicionar este cuadro de forma precisa sobre el mapa. */
            bottom: 10px; left: 10px; /* Lo coloca a 10px de los bordes inferior e izquierdo del mapa. */
            background: rgba(255, 255, 255, 0.9); /* Fondo blanco semitransparente, para que se vea un poco el mapa detr√°s. */
            padding: 10px 15px; /* Espaciado interno para el texto. */
            border-radius: 8px; /* Bordes redondeados. */
            border: 1px solid #ccc; /* Un borde sutil. */
            z-index: 1000; /* Asegura que este cuadro est√© siempre por encima del mapa y otros elementos. */
            display: none; /* Inicialmente, el cuadro est√° oculto y solo se mostrar√° cuando haya informaci√≥n de ruta. */
            font-size: 0.9em; /* Tama√±o de fuente ligeramente m√°s peque√±o. */
            color: #333; /* Color de texto oscuro para buena legibilidad. */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* A√±ade una sombra para darle un efecto de "flotante". */
        }
        /* Estilos para el mensaje de error que se muestra al usuario */
        #error-message {
            color: #ef4444; /* Color de texto rojo brillante para indicar un error. */
            margin-top: 15px; /* Espacio superior. */
            font-weight: 500; /* Texto ligeramente m√°s negrita. */
            display: none; /* Inicialmente oculto, solo se muestra si ocurre un error. */
            text-align: center; /* Centra el texto del mensaje de error. */
            padding: 10px; /* Relleno interno. */
            background-color: #fee2e2; /* Fondo rojo claro para el mensaje. */
            border-radius: 8px; /* Bordes redondeados. */
            border: 1px solid #fca5a5; /* Borde rojo claro. */
        }
        /* Estilos para la secci√≥n de encabezado con imagen de fondo */
        .header-bg-image {
            background-image: url('https://www.peru.travel/Contenido/Atractivo/Imagen/es/14/1.1/Principal/centro-historico-de-lima.jpg'); /* Define la imagen de fondo de la secci√≥n principal, una vista del centro hist√≥rico de Lima. */
            background-size: cover; /* Asegura que la imagen cubra todo el espacio disponible. */
            background-position: center; /* Centra la imagen de fondo. */
            position: relative; /* Necesario para posicionar el 'overlay' oscuro sobre la imagen. */
            overflow: hidden; /* Oculta cualquier parte de la imagen que se salga del contenedor. */
        }
        /* Pseudo-elemento para crear un overlay oscuro sobre la imagen de fondo del encabezado */
        .header-bg-image::before {
            content: ''; /* Es un elemento "fantasma" que se genera para crear el efecto. */
            position: absolute; /* Se posiciona de forma absoluta sobre la imagen. */
            top: 0; left: 0; right: 0; bottom: 0; /* Lo extiende para cubrir toda la secci√≥n. */
            background: rgba(0, 0, 0, 0.4); /* Crea una capa semitransparente oscura, lo que hace que el texto blanco encima sea m√°s legible. */
            z-index: 1; /* Lo coloca sobre la imagen pero debajo del contenido de texto. */
        }
        /* Estilos para el contenido dentro de la secci√≥n de encabezado (texto, t√≠tulos) */
        .header-content {
            position: relative; /* Asegura que el texto (t√≠tulo y subt√≠tulo) est√© por encima del 'overlay' oscuro. */
            z-index: 2; /* Lo coloca por encima del pseudo-elemento. */
        }
    </style>
</head>
<body class="font-sans text-gray-800">
    <!-- Secci√≥n del encabezado (Header) de la p√°gina -->
    <header class="bg-emerald-700 text-white p-4 shadow-md">
        <nav class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-3xl font-bold tracking-tight text-emerald-50 hover:text-emerald-200">UrbanBeat</a> <!-- El logo o nombre de la aplicaci√≥n, con estilos de Tailwind para tama√±o, negrita y color. -->
            <!-- Lista de enlaces de navegaci√≥n -->
            <ul class="flex space-x-6">
                <li><a href="#" class="hover:text-emerald-200">Inicio</a></li>
                <li><a href="#" class="hover:text-emerald-200">Explorar</a></li>
                <li><a href="#" class="hover:text-emerald-200">Acerca de</a></li>
                <li><a href="#" class="hover:text-emerald-200">Contacto</a></li>
            </ul>
        </nav>
    </header>
    <!-- Secci√≥n de bienvenida con imagen de fondo y texto principal -->
    <section class="header-bg-image py-20 px-4 text-center text-white">
        <div class="header-content container mx-auto">
            <h1 class="text-5xl font-extrabold mb-4 leading-tight">UrbanBeat</h1> <!-- El t√≠tulo principal de la aplicaci√≥n, grande y llamativo. -->
            <p class="text-xl opacity-90">Tu pulso urbano en Lima</p> <!-- Un subt√≠tulo que describe brevemente el prop√≥sito de la app. -->
        </div>
    </section>

    <!-- Contenido principal de la p√°gina (Main) -->
    <main class="container mx-auto py-12 px-4 flex-grow">
        <h2 class="text-4xl font-bold text-center mb-6 text-emerald-800">Visor Autom√°tico de Rutas</h2> <!-- T√≠tulo de la secci√≥n donde el usuario interactuar√°. -->
        <p class="text-center text-gray-600 mb-8">Busca un lugar y visualiza la ruta generada autom√°ticamente.</p> <!-- Instrucci√≥n para el usuario. -->

        <!-- Formulario de b√∫squeda -->
        <div class="flex flex-col md:flex-row gap-4 justify-center mb-8">
            <input id="query" type="text" placeholder="¬øQu√© buscas? (ej. restaurante)" class="px-4 py-2 border border-gray-300 rounded-md w-full md:w-1/3"> <!-- Campo de texto para la consulta del usuario (qu√© busca). -->
            <input id="location" type="text" placeholder="¬øD√≥nde? (ej. Cieneguilla, Lima, Per√∫)" class="px-4 py-2 border border-gray-300 rounded-md w-full md:w-1/3"> <!-- Campo de texto para la ubicaci√≥n. Aqu√≠ es donde el usuario puede especificar la ubicaci√≥n, ya que la detecci√≥n autom√°tica no fue posible. -->
            <button onclick="realizarBusqueda()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 hover:scale-105">
                Realizar B√∫squeda üîç <!-- Bot√≥n que, al ser clicado, activa la funci√≥n JavaScript 'realizarBusqueda()' para procesar la entrada. -->
            </button>
        </div>

        <div id="error-message" class="max-w-md mx-auto"></div> <!-- Div donde se mostrar√°n los mensajes de error al usuario, si los hay. -->

        <!-- Contenedor del mapa y su informaci√≥n superpuesta -->
        <div id="map-container" class="relative bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden mt-8">
            <div id="map" class="min-h-[300px] md:min-h-[500px]"></div> <!-- El div donde Leaflet renderizar√° el mapa interactivo. -->
            <div id="info"></div> <!-- Div para mostrar detalles de la ruta (distancia, tiempo) una vez que se genere. -->
        </div>
    </main>

    <!-- Contenedor del iframe de TripAdvisor -->
    <div id="tripadvisor-container" class="container mx-auto my-12 px-4 hidden"> <!-- Este contenedor est√° inicialmente oculto. Se har√° visible cuando se genere una ruta. -->
        <h3 class="text-2xl font-semibold text-center text-emerald-800 mb-4">Explora en TripAdvisor</h3> <!-- T√≠tulo de la secci√≥n de TripAdvisor. -->
        <iframe id="tripadvisor-frame"
                class="w-full h-[500px] rounded-lg border-2 border-emerald-400 shadow-md"
                loading="lazy" <!-- 'lazy loading' significa que el iframe solo se cargar√° cuando est√© a punto de aparecer en la pantalla, mejorando el rendimiento. -->
                referrerpolicy="no-referrer" <!-- Una medida de seguridad que evita enviar informaci√≥n de la p√°gina de origen al sitio de TripAdvisor. -->
                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"> <!-- Restricciones de seguridad para el contenido del iframe, limitando lo que puede hacer TripAdvisor dentro de nuestra p√°gina. -->
        </iframe>
    </div>
    <!-- Secci√≥n del pie de p√°gina (Footer) -->
    <footer class="bg-gray-800 text-white py-6 px-4 text-center mt-auto">
        <div class="container mx-auto">
            <p>&copy; 2025 UrbanBeat. Todos los derechos reservados.</p> <!-- Informaci√≥n de copyright y a√±o de la aplicaci√≥n. -->
        </div>
    </footer>
    <!-- Script JavaScript para la l√≥gica interactiva de la aplicaci√≥n -->
    <script>
        // Variables globales para el manejo del mapa y el estado de la b√∫squeda
        let map; // Esta variable almacenar√° la instancia del objeto mapa de Leaflet, permitiendo manipularlo desde cualquier funci√≥n.
        let lastQuery = ''; // Guarda la √∫ltima consulta de b√∫squeda (ej. "restaurante") para usarla en el cuadro de informaci√≥n.
        let lastLocation = ''; // Guarda la √∫ltima ubicaci√≥n de b√∫squeda (ej. "Lima, Per√∫") para el mismo prop√≥sito.

        /**
         * @function initializeMap
         * @description Inicializa o reinicializa el mapa de Leaflet.
         * Si ya existe una instancia de mapa, la remueve para evitar duplicados.
         * Centra el mapa en Lima y a√±ade la capa base de OpenStreetMap.
         */
        function initializeMap() {
            if (map) map.remove(); // Si ya hay un mapa cargado, lo eliminamos para evitar superposiciones o errores al reinicializar.
            map = L.map('map').setView([-12.0464, -77.0428], 12); // Creamos una nueva instancia del mapa Leaflet, vincul√°ndola al div con id 'map'. Lo centramos en las coordenadas de Lima y establecemos un nivel de zoom inicial de 12.
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' // A√±adimos la capa de teselas de OpenStreetMap, que son las "im√°genes" del mapa. La atribuci√≥n es un requisito legal.
            }).addTo(map); // Agregamos la capa de teselas a nuestro mapa reci√©n creado.
        }

        /**
         * @async
         * @function realizarBusqueda
         * @description Funci√≥n as√≠ncrona que se ejecuta al hacer clic en el bot√≥n "Realizar B√∫squeda".
         * Obtiene los valores de los campos de consulta y ubicaci√≥n, los env√≠a a un servidor backend
         * (asumido en `http://localhost:5000`) y, si la respuesta es exitosa, llama a 'loadAndVisualizeRoute()'.
         * Maneja los errores de la llamada al backend y los muestra al usuario.
         */
        async function realizarBusqueda() {
            const query = document.getElementById('query').value.trim(); // Captura el texto ingresado en el campo de "qu√© buscas" y elimina espacios extra.
            const location = document.getElementById('location').value.trim(); // Captura el texto ingresado en el campo de "d√≥nde" y elimina espacios extra.
            const errorDiv = document.getElementById('error-message'); // Obtenemos una referencia al div donde mostraremos mensajes de error.
            errorDiv.style.display = 'none'; // Ocultamos cualquier mensaje de error anterior antes de una nueva b√∫squeda.

            lastQuery = query; // Guardamos la consulta para mostrarla en el cuadro de informaci√≥n de la ruta.
            lastLocation = location; // Guardamos la ubicaci√≥n para mostrarla y usarla en el iframe de TripAdvisor.

            try {
                // Realizamos una solicitud POST a nuestra API backend. Esta API se encarga de procesar la b√∫squeda y generar la ruta.
                const res = await fetch('http://localhost:5000/api/ejecutar', {
                    method: 'POST', // El m√©todo POST se usa para enviar datos al servidor.
                    headers: { 'Content-Type': 'application/json' }, // Indicamos que el cuerpo de la solicitud es JSON.
                    body: JSON.stringify({ query, location }) // Convertimos los datos de la b√∫squeda a formato JSON y los enviamos.
                });
                const data = await res.json(); // Esperamos la respuesta del servidor y la parseamos como JSON.

                if (data.success) {
                    await loadAndVisualizeRoute(); // Si el backend nos dice que la operaci√≥n fue exitosa, procedemos a cargar y dibujar la ruta en el mapa.
                    // Limpiamos los campos de entrada para que el usuario pueda realizar una nueva b√∫squeda f√°cilmente.
                    document.getElementById('query').value = "";
                    document.getElementById('location').value = "";
                } else {
                    // Si el backend reporta un error (data.success es false), lanzamos una excepci√≥n con el mensaje de error.
                    throw new Error(data.message || 'Error desconocido');
                }
            } catch (e) {
                // Si ocurre cualquier error durante la comunicaci√≥n con el backend (ej. el servidor no responde, error de red), lo capturamos aqu√≠.
                errorDiv.textContent = `‚ùå ${e.message}`; // Mostramos el mensaje de error al usuario en el div 'error-message'.
                errorDiv.style.display = 'block'; // Hacemos visible el div de error.
            }
        }

        /**
         * @async
         * @function loadAndVisualizeRoute
         * @description Funci√≥n as√≠ncrona que carga los datos de la ruta desde el archivo 'ruta.json'
         * (asumido que es generado por el backend) y los dibuja en el mapa.
         * Tambi√©n actualiza el cuadro de informaci√≥n de la ruta y muestra el iframe de TripAdvisor.
         */
        async function loadAndVisualizeRoute() {
            const errorDiv = document.getElementById('error-message'); // Obtenemos la referencia al div de errores.
            errorDiv.style.display = 'none'; // Ocultamos cualquier error previo.

            // Limpiamos cualquier ruta o marcadores anteriores en el mapa para dibujar la nueva.
            if (window.routeLayer) map.removeLayer(window.routeLayer);
            if (window.startMarker) map.removeLayer(window.startMarker);
            if (window.endMarker) map.removeLayer(window.endMarker);

            const infoDiv = document.getElementById('info'); // Obtenemos la referencia al div de informaci√≥n de la ruta.
            infoDiv.style.display = 'none'; // Ocultamos cualquier informaci√≥n previa.

            try {
                // Intentamos cargar el archivo 'ruta.json'. Este archivo contiene las coordenadas y propiedades de la ruta generada.
                const response = await fetch('ruta.json');
                if (!response.ok) throw new Error('No se pudo cargar el archivo ruta.json'); // Si el archivo no se carga correctamente (ej. error 404), lanzamos un error.
                const routeData = await response.json(); // Parseamos los datos del archivo JSON.

                const route = routeData.features[0]; // Accedemos a la primera caracter√≠stica (feature) de la ruta (asumiendo un formato GeoJSON).
                // Mapeamos las coordenadas de la ruta al formato [latitud, longitud] que Leaflet espera para dibujar l√≠neas.
                const coords = route.geometry.coordinates[0].map(c => [c[1], c[0]]);
                // Creamos una l√≠nea de polil√≠nea en el mapa usando las coordenadas, definiendo su color, grosor y opacidad.
                const routeLine = L.polyline(coords, { color: '#3b82f6', weight: 5, opacity: 0.7 });

                // Creamos marcadores para el punto de inicio y fin de la ruta, a√±adi√©ndoles un peque√±o mensaje (popup).
                const startMarker = L.marker(coords[0]).bindPopup("üìç Inicio");
                const endMarker = L.marker(coords[coords.length - 1]).bindPopup("üèÅ Fin");

                // Guardamos las referencias a los marcadores y la capa de ruta en el objeto 'window' para poder eliminarlos en futuras b√∫squedas.
                window.startMarker = startMarker;
                window.endMarker = endMarker;
                window.routeLayer = L.layerGroup([routeLine, startMarker, endMarker]).addTo(map); // Agrupamos la l√≠nea y los marcadores en una capa y la a√±adimos al mapa.
                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] }); // Ajustamos la vista del mapa para que toda la ruta sea visible, con un margen.

                // Calculamos la distancia y el tiempo de la ruta a partir de las propiedades de los datos.
                const distancia = (route.properties.distance / 1000).toFixed(2); // Convertimos metros a kil√≥metros y redondeamos a 2 decimales.
                const tiempo = (route.properties.time / 60).toFixed(1); // Convertimos segundos a minutos y redondeamos a 1 decimal.

                // Actualizamos el contenido del div de informaci√≥n con los detalles de la ruta y las b√∫squedas realizadas.
                infoDiv.innerHTML = `<b>Buscaste:</b> ${document.getElementById('query').value || lastQuery}<br><b>En:</b> ${document.getElementById('location').value || lastLocation}<br><b>Distancia:</b> ${distancia} km<br><b>Tiempo:</b> ${tiempo} min`;
                infoDiv.style.display = 'block'; // Hacemos visible el div de informaci√≥n.

                // Integraci√≥n con TripAdvisor: Mostramos un iframe con b√∫squedas relacionadas.
                const tripFrameDiv = document.getElementById('tripadvisor-container'); // Referencia al contenedor del iframe.
                const tripFrame = document.getElementById('tripadvisor-frame'); // Referencia al iframe.
                // Construimos la URL de b√∫squeda de TripAdvisor usando la √∫ltima ubicaci√≥n.
                tripFrame.src = `https://www.tripadvisor.com.pe/Search?q=${encodeURIComponent(lastLocation)}`;
                tripFrameDiv.style.display = 'block'; // Hacemos visible el contenedor del iframe.

            } catch (e) {
                // Capturamos y mostramos cualquier error que ocurra al cargar o visualizar la ruta (ej. archivo JSON corrupto).
                errorDiv.textContent = `Error al mostrar la ruta: ${e.message}`; // Mostramos el mensaje de error.
                errorDiv.style.display = 'block'; // Hacemos visible el div de error.
            }
        }

        // Event Listener: Este es crucial. Asegura que la funci√≥n 'initializeMap()' se ejecute
        // solo cuando todo el contenido HTML de la p√°gina (el DOM) ha sido completamente cargado.
        // Esto evita errores al intentar manipular el mapa antes de que su contenedor exista en la p√°gina.
        document.addEventListener('DOMContentLoaded', initializeMap);
